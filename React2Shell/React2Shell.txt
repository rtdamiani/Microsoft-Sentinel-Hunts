

let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
let IOCs = dynamic(["hxxp://46.36.37.85:12000/sex.sh" ,"reactcdn.windowserrorapis.com" ,"193.142.147.209" ,"82.163.22.139" ,"216.158.232.43" ,"45.76.155.14" ,"115.42.60.223" ,"193.142.147.209" ,"194.69.203.32" ,"82.163.22.139" ,"216.158.232.43" ,"45.76.155.14" ,"54.39.28.147" ,"140.99.223.178" ,"156.234.209.103" ,"38.162.112.141" ,"45.32.158.54" ,"46.36.37.85" ,"47.84.79.46" ,"95.169.180.135" ,"216.158.232.43" ,"196.251.100.191" ,"92.246.87.48" ,"hxxp://46.36.37.85:12000/sex.sh" ,"hxxp://115.42.60.223:61236/slt" ,"hxxp://45.32.158.54/5e51aff54626ef7f/x86_64" ,"hxxp://115.42.60.223:61236/slt" ,"hxxp://45.32.158.54/5e51aff54626ef7f/x86_64" ,"hxxp://115.42.60.223:61236/slt" ,"hxxp://156.234.209.103:20912/get.sh" ,"hxxp://156.234.209.103:20913/get.sh" ,"hxxp://45.32.158.54/5e51aff54626ef7f/x86_64" ,"hxxp://46.36.37.85:12000/sex.sh" ,"hxxp://95.169.180.135:8443/pamssod" ,"hxxp://46.36.37.85:12000/sex.sh" ,"hxxp://res.qiqigece.top/nginx1" ,"hxxps://raw.githubusercontent.com/C3Pool/xmrig_setup/master/setup_c3pool_miner.sh" ,"hxxps://sup001.oss-cn-hongkong.aliyuncs.com/123/python1.sh" ,"reactcdn.windowserrorapis.com" ,"res.qiqigece.top" ,"hxxp://193.24.123.68:3001/gfdsgsdfhfsd_ghsfdgsfdgsdfg.sh" ,"192.238.202.17" ,"hxxp://146.88.129.138:5511/443nb64" ,"115.42.60.223" ,"tcp://vip.kof97.lol:443/" ,"hxxp://194.69.203.32:81/hiddenbink/colonna.arc" ,"hxxp://194.69.203.32:81/hiddenbink/colonna.i686" ,"hxxp://194.69.203.32:81/hiddenbink/react.sh" ,"hxxp://196.251.100.191/no_killer/Exodus.arm4" ,"hxxp://196.251.100.191/no_killer/Exodus.x86" ,"hxxp://196.251.100.191/no_killer/Exodus.x86_64" ,"hxxp://196.251.100.191/update.sh" ,"hxxp://anywherehost.site/xms/k1.sh" ,"hxxp://anywherehost.site/xms/kill2.sh" ,"hxxp://donaldjtrmp.anondns.net:1488/labubu" ,"hxxp://krebsec.anondns.net:2316/dong" ,"hxxps://hybird-accesskey-staging-saas.s3.dualstack.ap-northeast-1.amazonaws.com/agent" ,"hxxp://superminecraft.net.br:3000/sex.sh" ,"anywherehost.site" ,"xpertclient.net" ,"vps-zap812595-1.zap-srv.com" ,"superminecraft.net.br" ,"donaldjtrmp.anondns.net" ,"labubu.anondns.net" ,"krebsec.anondns.net" ,"hybird-accesskey-staging-saas.s3.dualstack.ap-northeast-1.amazonaws.com"]);
DeviceEvents | union DeviceProcessEvents | union DeviceFileEvents | union DeviceNetworkEvents | union SecurityEvent | union CommonSecurityLog | union EmailEvents | union EmailAttachmentInfo | union EmailUrlInfo | union UrlClickEvents | union SigninLogs | union CloudAppEvents
| where TimeGenerated > ago(30d)
| extend CommandLineIP = extract(IPRegex, 0, InitiatingProcessCommandLine)
| extend CommandLineIP1 = extract(IPRegex, 0, ProcessCommandLine)
| extend CommandLineIP2 = extract(IPRegex, 0, CommandLine)
| extend CommandLineUrl = extract(@"(https?://[^\s'\""<>)]+)", 1, tostring(InitiatingProcessCommandLine))
| extend CommandLineUrl1 = extract(@"(https?://[^\s'\""<>)]+)", 1, tostring(ProcessCommandLine))
| extend CommandLineUrl2 = extract(@"(https?://[^\s'\""<>)]+)", 1, tostring(CommandLine))
| extend query = tostring(parse_json(AdditionalFields).query)
| extend EncodedCommand = extract(@'\s+([A-Za-z0-9+/]{20}\S+$)', 1, ProcessCommandLine)
| extend DecodedCommand = base64_decode_tostring(EncodedCommand)
| where SourceIP has_any (IOCs) or DestinationIP has_any (IOCs) or LocalIP has_any (IOCs) or RemoteIP has_any (IOCs) or SenderIPv4 has_any (IOCs) or RequestURL has_any (IOCs) or Url has_any (IOCs) or IPAddress has_any (IOCs) or RemoteUrl has_any (IOCs) or CommandLineIP has_any (IOCs) or CommandLineIP1 has_any (IOCs) or CommandLineUrl has_any (IOCs) or CommandLineUrl1 has_any (IOCs) or DestinationHostName has_any (IOCs) or query has_any (IOCs) or DecodedCommand has_any (IOCs) or FileOriginUrl has_any (IOCs) or ProcessRemoteSessionIP has_any (IOCs) or InitiatingProcessRemoteSessionIP has_any (IOCs) or ProcessCommandLine has_any (IOCs) or InitiatingProcessCommandLine has_any (IOCs)
| project-reorder Type, TimeGenerated, ActionType, DeviceAction, InitiatingProcessAccountName, AccountName, DeviceName, Computer, InitiatingProcessParentFileName, InitiatingProcessFileName, FileName, InitiatingProcessFolderPath, FolderPath, SourceIP, DestinationIP, LocalIP, RemoteIP, SenderIPv4, RequestURL, DestinationHostName, Url, RemoteUrl, SHA256, SHA1, InitiatingProcessSHA1, InitiatingProcessSHA256, CommandLineIP, CommandLineIP1, CommandLineIP2, CommandLineUrl, CommandLineUrl1, CommandLineUrl2, query, DecodedCommand, FileOriginUrl, ProcessRemoteSessionIP, InitiatingProcessRemoteSessionIP




let IOCs = dynamic(["8a8951ffcbede6f4bedff6f3191179fd" ,"8bb6514ac3935479902820d0486df8b6abee73dd" ,"df3f20a961d29eed46636783b71589c183675510737c984a11f78932b177b540" ,"ma0oqd17.exe" ,"10231e4c2ade4f21c9d4fa52cabc8b5e" ,"972fe0233cea777f69ba5f081d60219eba73c617" ,"92064e210b23cf5b94585d3722bf53373d54fb4114dca25c34e010d0c010edf3" ,"bf972l.exe" ,"1b0de91ffdb3bbb71c9cbf37c31299d0" ,"b66e7b8f153779ae8521248b502fcf5e5116b3af" ,"a455731133c00fdd2a141bdfba4def34ae58195126f762cdf951056b0ef161d4" ,"a455731133c00fdd2a141bdfba4def34ae58195126f762cdf951056b0ef161d4" ,"8a8951ffcbede6f4bedff6f3191179fd" ,"8bb6514ac3935479902820d0486df8b6abee73dd" ,"df3f20a961d29eed46636783b71589c183675510737c984a11f78932b177b540" ,"10231e4c2ade4f21c9d4fa52cabc8b5e" ,"972fe0233cea777f69ba5f081d60219eba73c617" ,"92064e210b23cf5b94585d3722bf53373d54fb4114dca25c34e010d0c010edf3" ,"1b0de91ffdb3bbb71c9cbf37c31299d0" ,"b66e7b8f153779ae8521248b502fcf5e5116b3af" ,"a455731133c00fdd2a141bdfba4def34ae58195126f762cdf951056b0ef161d4" ,"a455731133c00fdd2a141bdfba4def34ae58195126f762cdf951056b0ef161d4" ,"40cab74bfacd7ba8fa46c8dcbdf7cae3" ,"6bd5c6af884d46638ebc60434cfd35b37c1d3dd4" ,"33641bfbbdd5a9cd2320c61f65fe446a2226d8a48e3bd3c29e8f916f0592575f" ,"10d7dd6dd56aa9c2c04d9ea0d60ee7ed" ,"e3dd33183ce13cbd184a7ebbe70edab97bb0f5cc" ,"4a759cbc219bcb3a1f8380a959307b39873fb36a9afd0d57ba0736ad7a02763b" ,"1b0de91ffdb3bbb71c9cbf37c31299d0" ,"b66e7b8f153779ae8521248b502fcf5e5116b3af" ,"a455731133c00fdd2a141bdfba4def34ae58195126f762cdf951056b0ef161d4" ,"6e30ce3e09f20e3a60c8aabb2a0fdc1c" ,"5619b1c26a23919a2ea1e698ece953455da2fa95" ,"1663d98c259001f1b03f82d0c5bee7cfd3c7623ccb83759c994f9ab845939665" ,"191077aa5409a2d23f5040aea136f963" ,"1539b2eb380fdf7c5ddc7c017118a81cf82bf774" ,"55ae00bc8482afd085fd128965b108cca4adb5a3a8a0ee2957d76f33edd5a864" ,"6caed5cb0d10a97415f61cd5f53d8b76" ,"8907872767c587733bdaa7d91dab2f9cb75d21e1" ,"62e9a01307bcf85cdaeecafd6efb5be72a622c43a10f06d6d6d3b566b072228d" ,"c3a836627fcafe73bde6c749188247cc" ,"7ebb18d9a9cb71b24f301196c5cf61fb1ea0e68c" ,"7f05bad031d22c2bb4352bf0b6b9ee2ca064a4c0e11a317e6fedc694de37737a" ,"99d82ec88a3c32e372e30849c673f5ee" ,"cfdfff471b4ab7eb6accee7cb4907d2063d82529" ,"ac7027f30514d0c00d9e8b379b5ad8150c9827c827dc7ee54d906fc2585b6bf6" ,"c3a836627fcafe73bde6c749188247cc" ,"7ebb18d9a9cb71b24f301196c5cf61fb1ea0e68c" ,"7f05bad031d22c2bb4352bf0b6b9ee2ca064a4c0e11a317e6fedc694de37737a" ,"533585eb6a8a4aad2ad09bbf272eb45b" ,"1b5aba88ba7c4011d081b499ce6009df69e5dbcf" ,"776850a1e6d6915e9bf35aa83554616129acd94e3a3f6673bd6ddaec530f4273" ,"c3a836627fcafe73bde6c749188247cc" ,"7ebb18d9a9cb71b24f301196c5cf61fb1ea0e68c" ,"7f05bad031d22c2bb4352bf0b6b9ee2ca064a4c0e11a317e6fedc694de37737a" ,"1ec6e297b91ea0df9beaba68c244aa9e" ,"0038b79f25d8be268857f16e681cc4c064012c4d" ,"c6c7e7dd85c0578dd7cb24b012a665a9d5210cce8ff735635a45605c3af1f6ad" ,"55d5c30e245c8c5125b58a3874b0ad8e" ,"4de90454b2c8ed4058d04d4e6991744f713809ac" ,"b568582240509227ff7e79b6dc73c933dcc3fae674e9244441066928b1ea0560" ,"025f5e04e54497242749ec480310fd7e" ,"03b85aa66be2303790b0cc053f8584d054a8b6ee" ,"69f2789a539fc2867570f3bbb71102373a94c7153239599478af84b9c81f2a03" ,"bef192d23b72aaf9698967dacaf35c07" ,"7b88cb40b60323984a5e8fb976c2a443cc26b244" ,"68de36f14a7c9e9514533a347d7c6bc830369c7528e07af5c93e0bf7c1cd86df" ,"08ceabdf598ab32c64d6d116321acffe" ,"73bad19d9691d4be546d30d0312ef2a2ddb908c8" ,"717c849a1331b63860cefa128a4aa5d476f300ac45fd5d3c56b2746f7e72a0d2" ,"5195b79d7d774c13ff6f0e01c3a13b72" ,"c69d070eec638bf2a7cb7afb3a1697daedba937e" ,"7909046e5e0fd60461b721c0ef7cfe5899f76672e4970d629bb51bb904a05398" ,"622f904bb82c8118da2966a957526a2b" ,"09e42ebca5a59b128246a08827c040220ae1c2cb" ,"7e0a0c48ee0f65c72a252335f6dcd435dbd448fc0414b295f635372e1c5a9171" ,"83f9a3b82b523a6ac7ff563cda668784" ,"eb596630399a04f7c7cddd044112fb9d31faecae" ,"b33d468641a0d3c897e571426804c65daae3ed939eab4126c3aa3fa8531de5e8" ,"ce084a61846a9b4618bfd4ceed2e1361" ,"37a5358f85584d5c773e8a2ee1552219f1a2670d" ,"f0b66629fe8ad71779df5e4126c389e7702f975049bd17cb597ebcf03c6b110b" ,"9ecb0c09dda59e5d4af1a81a995e8f9e" ,"6c9b865092a66d217249ef81f70e4e4cd60269dd" ,"59630d8f3b4db5acbcaccc0cfa54500f2bbb0745d4b5c50d903636f120fc8700" ,"23decc99dfefb103db790227247563bd" ,"86c82af9ff33fb2aa29a1d02aac55fdf583375bb" ,"82335954bec84cbdd019cfa474f20f4274310a1477e03e34af7c62d15096fe0d" ,"cd70aae059394a6990b81ec42a9d0079" ,"94992eaa2a98b040200f4fb899e03c26e6a355dd" ,"f0d3d5668a4df347eb0a59df167acddb245f022a518a6d15e37614af0bbc2adf" ,"215e2a506768efe006e5d0871d3d3e1d" ,"e60cb26e0c779f4a343a239b44178d6e78a2176d" ,"317e10c4068b661d3721adaa35a30728739defddbc72b841c3d06aca0abd4d5e" ,"fe02c31a7ac048e5672d8c8128fbf134" ,"c2b97e14b63b7e8fd4d4479cfb74a50f94e1d419" ,"0aad73947fb1876923709213333099b8c728dde9f5d86acfd0f3702a963bae6a" ,"ec20124398e61ed22cad1b3409134a9d" ,"c17653c46416952dd6609768f5b9ed4623d0da81" ,"9dde35ba8e132ebed29e70f57da0c4f36a9401a7bbd36e6ddd257e0920aa4083" ,"5dc9adec552665516b8e3ad478d5b162" ,"d9de239e81e85cc0ccd4c2d53c94f509d673d6b0" ,"240afa3a6457f1ee866f6f03ff815009ff8fd7b70b902bc59b037ac54b6cae9b" ,"be57570e68bc503887a5d8c16aeae6e7" ,"25ff6b77ff24d2267ceced55b707f6b3b2cb1c95" ,"8e07beb854f77e90c174829bd4e01e86779d596710ad161dbc0e02a219d6227f" ,"7eff269600d58f72b4e823c054c7a4fa" ,"e89e25205875ef412698cf083c0e2b3cafead1e5" ,"244bf271d2e55cd737980322de37c2c2792154b4cf4e4893e9908c2819026e5f"]);
DeviceEvents | union DeviceProcessEvents | union DeviceFileEvents | union DeviceNetworkEvents | union SecurityEvent | union CommonSecurityLog | union EmailEvents | union EmailAttachmentInfo | union EmailUrlInfo | union UrlClickEvents | union SigninLogs
| where TimeGenerated > ago(30d)
| where SHA256 has_any (IOCs) or SHA1 has_any (IOCs) or MD5 has_any (IOCs) or InitiatingProcessSHA1 has_any (IOCs) or InitiatingProcessSHA256 has_any (IOCs) or InitiatingProcessMD5 has_any (IOCs) or FolderPath has_any (IOCs) or ProcessName has_any (IOCs) or NewProcessName has_any (IOCs) or ParentProcessName has_any (IOCs) or InitiatingProcessFolderPath has_any (IOCs) or InitiatingProcessParentFileName has_any (IOCs) or InitiatingProcessFileName has_any (IOCs) or FileName has_any (IOCs) 
| project-reorder Type, TimeGenerated, ActionType, DeviceAction, InitiatingProcessAccountName, AccountName, DeviceName, Computer, InitiatingProcessParentFileName, InitiatingProcessFileName, FileName, InitiatingProcessFolderPath, FolderPath, SourceIP, DestinationIP, LocalIP, RemoteIP, SenderIPv4, RequestURL, Url, RemoteUrl, SHA256, SHA1, InitiatingProcessSHA1, InitiatingProcessSHA256


RCE Suspeita - Processo Filho Node.js: Detecta a criação de processos shell ou downloaders por um processo Node.js, indicando possível execução remota de código (RCE) via React2Shell.

DeviceProcessEvents
| where TimeGenerated > ago(30d)
| where InitiatingProcessFileName has_any ("node", "nodejs")
| where InitiatingProcessCommandLine has_any ("next", "react-scripts")
| where FileName in ("sh", "bash", "curl", "wget", "python", "python3")
| project TimeGenerated, DeviceName, InitiatingProcessCommandLine, ProcessCommandLine, FileName, InitiatingProcessParentFileName, ActionType


Download e Execução de Script Malicioso: Identifica downloads de scripts shell por curl, wget ou python seguidos de execução, comum na fase de implantação do EtherRAT.

DeviceProcessEvents
| where TimeGenerated > ago(30d)
| where (FileName in ("curl", "wget") and ProcessCommandLine contains ".sh -o") or (FileName contains "python" and ProcessCommandLine contains "urllib.request")
| extend DownloadedScriptPath = extract_all(@"-o\s+([^ ]+)|-O\s+([^ ]+)|open\('([^']+)'", ProcessCommandLine)[0]
| join kind=inner (
    DeviceProcessEvents
    | where TimeGenerated > ago(30d)
    | where FileName endswith ".sh"
    | extend ExecutedScriptPath = ProcessCommandLine
) on $left.DeviceName == $right.DeviceName


Conexões C2 para IPs Maliciosos Conhecidos: Alerta sobre tentativas de comunicação com endereços IP ou domínios associados à infraestrutura de C2 do EtherRAT.

DeviceNetworkEvents
| where TimeGenerated > ago(30d)
| where RemoteIP in ("45.32.158.54", "38.162.112.141", "193.24.123.68", "146.88.129.138", "115.42.60.223")
   or RemoteUrl contains "reactcdn.windowserrorapis.com"
| project TimeGenerated, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, RemoteIP, RemotePort, RemoteUrl, ActionType



Atividade de Reverse Shell: Detecta padrões de comandos que criam uma shell reversa, um método comum de acesso pós-exploração.

DeviceProcessEvents
| where TimeGenerated > ago(30d)
| where ProcessCommandLine contains "bash -i" and ProcessCommandLine contains ">& /dev/tcp/" and ProcessCommandLine contains "0>&1"
| project TimeGenerated, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, ProcessCommandLine, FileName, ActionType



Criação de Diretório Oculto Malicioso: Detecta a criação de diretórios ocultos com padrões hexadecimal ou .local/share/. que são comumente usados para hospedar payloads maliciosos.

DeviceFileEvents
| where TimeGenerated > ago(30d)
| where ActionType == "FileCreated"
| where FolderPath matches regex @".*\/(\.local\/share\/\.[0-9a-fA-F]{8,})"
| project TimeGenerated, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, FolderPath



Modificação Suspeita de Arquivo de Configuração do Shell: Identifica modificações em arquivos de configuração do shell (.bashrc, .profile) por processos incomuns, indicando tentativas de persistência.

DeviceFileEvents
| where TimeGenerated > ago(30d)
| where ActionType in ("FileModified", "FileCreated")
| where FileName in (".bashrc", ".profile", ".zshrc")
| where FolderPath contains "/home/" or FolderPath contains "/root/"
| where InitiatingProcessFileName !in ("bash", "sh", "zsh", "code", "vim", "nano", "git", "chsh", "sftp", "scp")
| project TimeGenerated, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, FolderPath, FileName, ActionType


Criação de Serviço/Autostart Malicioso para Persistência: Detecta a criação de novos arquivos de serviço Systemd de usuário ou entradas no XDG Autostart, que são TTPs do EtherRAT para manter a persistência.

DeviceFileEvents
| where TimeGenerated > ago(30d)
| where ActionType == "FileCreated"
| where FolderPath contains "/.config/systemd/user/" or FolderPath contains "/.config/autostart/"
| where FileName endswith ".service" or FileName endswith ".desktop"
| where InitiatingProcessFileName !in ("systemctl", "xdg-autostart-editor", "gnome-shell", "kdeinit5", "dbus-daemon")
| project TimeGenerated, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, FolderPath, FileName











